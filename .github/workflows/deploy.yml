name: Deploy to Production

on:
  push:
    branches: [dev]
  workflow_dispatch:

# –î–æ–±–∞–≤–ª—è–µ–º permissions –¥–ª—è –∑–∞–ø–∏—Å–∏
permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # –í–∞–∂–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–µ—Ç–∫–∞–º–∏
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Run tests
      run: node test.js

  deploy-to-prod:
    needs: test
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Configure Git
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
    
    - name: Merge dev to prod
      run: |
        git fetch origin
        git checkout prod
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –º–µ—Ä–∂–∞ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
        git merge --no-ff origin/dev -m "üöÄ Deploy: Auto-merge from dev to prod $(date +'%Y-%m-%d %H:%M:%S')"
        git push origin prod